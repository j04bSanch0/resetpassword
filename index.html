<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset Password</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <style>
    html, body {
      height: 100%;
    }

    body {
      display: flex;
      align-items: center;
      background-color: gainsboro;
      min-height: 100vh;
    }

    .form-signin {
      width: 100%;
      max-width: 450px;
      margin: auto;
    }

    .form-signin .form-floating:focus-within {
      z-index: 2;
    }

    .card {
      border-radius: 1rem;
    }

    .password-wrapper {
      position: relative;
    }
    
    .password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: none;
      cursor: pointer;
      color: #6c757d;
      z-index: 5;
      display: none;
    }

    .password-toggle:focus {
      outline: none;
    }
  </style>
</head>
<body class="text-center">

<main class="form-signin card shadow-lg border-0">
  <div class="d-flex justify-content-center align-items-center">
    <div class="card-body p-4 p-md-5">

      <form onsubmit="return false;">
        <img class="mb-4" src="assets/actdologo.png" alt="Logo" width="120" height="120" style="object-fit:contain;">

        <h1 class="h3 mb-3 fw-normal">Reset Password</h1>

        <div class="form-floating mb-2">
          <input type="text" class="form-control" id="officerId" placeholder="Badge Number or ID">
          <label for="officerId">Badge Number or User ID</label>
        </div>

        <div class="form-floating mb-2 password-wrapper">
          <input type="password" class="form-control" id="newPassword" placeholder="New Password">
          <label for="newPassword">New Password</label>
          <button type="button" class="password-toggle" onclick="togglePassword('newPassword', this)">
            <i class="bi bi-eye-slash"></i>
          </button>
        </div>

        <div class="form-floating mb-3 password-wrapper">
          <input type="password" class="form-control" id="reEnterNewPassword" placeholder="Confirm Password">
          <label for="reEnterNewPassword">Confirm Password</label>
          <button type="button" class="password-toggle" onclick="togglePassword('reEnterNewPassword', this)">
            <i class="bi bi-eye-slash"></i>
          </button>
        </div>

        <button class="w-100 btn btn-lg btn-danger mt-2" type="button" id="resetPassBtn">Confirm Reset</button>
        
        <div class="mt-3">
            <a href="login.html" class="text-decoration-none text-muted">Back to Login</a>
        </div>

        <div id="error" class="mt-3 small fw-bold"></div>

      </form>

    </div> 
  </div>
</main> 

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  // Added query, orderByChild, equalTo
  import { getDatabase, ref, update, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDom67kW1EqsFixZ_cs-0K74aSbIlVQ3CQ",
    authDomain: "fir-crud-962b5.firebaseapp.com",
    databaseURL: "https://fir-crud-962b5-default-rtdb.firebaseio.com",
    projectId: "fir-crud-962b5",
    storageBucket: "fir-crud-962b5.firebasestorage.app",
    messagingSenderId: "154009210058",
    appId: "1:154009210058:web:37b5b690f52daef5027833"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const PBKDF2_ITERATIONS = 100000;
  const PBKDF2_HASH = "SHA-256";
  const PBKDF2_KEYLEN = 32;

  function ab2hex(buf) {
    return Array.from(new Uint8Array(buf))
      .map(x => ("00" + x.toString(16)).slice(-2))
      .join("");
  }

  function generateSalt(length = 16) {
    const salt = new Uint8Array(length);
    window.crypto.getRandomValues(salt);
    return salt.buffer;
  }

  async function pbkdf2(password, salt) {
    const enc = new TextEncoder();
    const keyMaterial = await window.crypto.subtle.importKey(
      "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveBits"]
    );
    return await window.crypto.subtle.deriveBits(
      { name: "PBKDF2", salt: salt, iterations: PBKDF2_ITERATIONS, hash: PBKDF2_HASH },
      keyMaterial, PBKDF2_KEYLEN * 8
    );
  }

  window.togglePassword = function(inputId, btnElement) {
    const input = document.getElementById(inputId);
    const icon = btnElement.querySelector('i');
    
    if (input.type === "password") {
        input.type = "text";
        icon.classList.replace('bi-eye-slash', 'bi-eye');
    } else {
        input.type = "password";
        icon.classList.replace('bi-eye', 'bi-eye-slash');
    }
  };

  ['newPassword', 'reEnterNewPassword'].forEach(id => {
    const input = document.getElementById(id);
    input.addEventListener('input', function() {
        const btn = this.parentElement.querySelector('.password-toggle');
        if(btn) btn.style.display = this.value.length > 0 ? 'block' : 'none';
    });
  });

  document.getElementById("resetPassBtn").addEventListener("click", async () => {
    const inputId = document.getElementById("officerId").value.trim();
    const newPass = document.getElementById("newPassword").value.trim();
    const rePass = document.getElementById("reEnterNewPassword").value.trim();
    const errorDiv = document.getElementById("error");

    errorDiv.style.color = "#dc3545"; 
    errorDiv.textContent = "";

    if (!inputId) {
      errorDiv.textContent = "Please enter a Badge Number or ID.";
      return;
    }
    if (!newPass || !rePass) {
      errorDiv.textContent = "Please fill in both password fields.";
      return;
    }
    if (newPass !== rePass) {
      errorDiv.textContent = "Passwords do not match.";
      return;
    }
    
   const missing = [];
    if (newPass.length < 8) missing.push("must be 8+ characters");
    if (!/[A-Z]/.test(newPass)) missing.push("must include an uppercase letter");
    if (!/[a-z]/.test(newPass)) missing.push("must include a lowercase letter");
    if (!/\d/.test(newPass)) missing.push("must include a number");
    if (!/[\W_]/.test(newPass)) missing.push("must include a special character (!@#$%)");

    if (missing.length > 0) {
      errorDiv.innerHTML = missing.join("<br>");
      return;
    }

    try {
        let foundPath = null;

        // 1. SEARCH OFFICER ACCOUNTS BY BADGE NUMBER (Using Query)
        const officerRef = ref(db, "Officer Accounts");
        // Query: Search 'Officer Accounts' where 'badge_number' == inputId
        const officerQuery = query(officerRef, orderByChild("badge_number"), equalTo(inputId));
        const officerSnapshot = await get(officerQuery);

        if (officerSnapshot.exists()) {
            const keys = Object.keys(officerSnapshot.val());
            const officerKey = keys[0]; 
            foundPath = `Officer Accounts/${officerKey}`;
        } 
       

        if (!foundPath) {
            errorDiv.textContent = "Badge Number not found.";
            return;
        }

        const saltBuffer = generateSalt();
        const hashBuffer = await pbkdf2(newPass, saltBuffer);
        const newSaltHex = ab2hex(saltBuffer);
        const newHashHex = ab2hex(hashBuffer);

        // Update the path we found
        await update(ref(db, foundPath), {
            PasswordHash: newHashHex,
            Salt: newSaltHex,
        });

        errorDiv.style.color = "#198754"; 
        errorDiv.textContent = "Password reset successful!";
        
        document.getElementById("newPassword").value = "";
        document.getElementById("reEnterNewPassword").value = "";
        
    } catch (err) {
      console.error(err);
      errorDiv.textContent = "Error resetting password. Please try again.";
    }
  });
</script>

</body>
</html>

